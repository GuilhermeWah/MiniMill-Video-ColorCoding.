# Test Report - November 19, 2025

## Summary
**Status**: ✅ PASSED
**Tests Run**: 7
**Tests Passed**: 7
**Tests Failed**: 0

## Execution Log
```powershell
pytest tests/
=================================== test session starts ====================================
platform win32 -- Python 3.10.11, pytest-9.0.0, pluggy-1.6.0
rootdir: C:\Users\guilh\OneDrive\Área de Trabalho\ColorCodingTest
configfile: pyproject.toml
collected 7 items

tests\test_models.py ..                                                               [ 28%] 
tests\test_playback.py ...                                                            [ 71%]
tests\test_processor.py ..                                                            [100%]

==================================== 7 passed in 0.40s ===================================== 
```

## Incident Report: Seeking Failure (FIXED)

### The Issue
The test `tests/test_playback.py::test_frameloader_seek` initially failed with:
`AssertionError: Seeking to frame 5 should leave 5 frames remaining (5-9)`
Actual result: 10 frames remaining (meaning it started from frame 0).

### Root Cause Analysis
The `FrameLoader.seek()` method had two critical flaws:
1.  **Incorrect PTS Calculation**: It used `stream.duration` and `total_frames` to calculate the target timestamp. In some video containers (like the MP4 created by OpenCV in the test), `total_frames` or `duration` might be zero or imprecise, leading to a seek target of 0.
2.  **Missing "Pre-roll" Handling**: Video compression uses "Keyframes" (I-frames). You can only seek directly to a keyframe. If frame 5 is not a keyframe, the decoder jumps to the nearest previous keyframe (e.g., frame 0). The iterator was not checking the current frame index, so it started yielding from frame 0 instead of skipping ahead to frame 5.

### The Fix
We modified `src/mill_presenter/core/playback.py` to:
1.  **Use Time Base**: Calculated the Presentation Timestamp (PTS) using the formula `(FrameIndex / FPS) / TimeBase`, which is more robust than relying on file-level duration metadata.
2.  **Implement Pre-roll Skip**: Added logic in `iter_frames` to calculate the exact index of each decoded frame (using `frame.pts`). If the decoded frame is before the requested `start_frame`, it is now discarded (skipped) until the target is reached.

### Verification
The test `test_frameloader_seek` now passes, confirming that requesting `start_frame=5` correctly yields exactly the last 5 frames of the 10-frame test video.
